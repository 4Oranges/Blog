# 闷声作大死：把声卡变成示波器
Sat, 16 Apr 2016 05:35:05 +0800

为了搞[FreeCopter](https://github.com/4Oranges/FreeCopter)，用了很多奇技淫巧。其中有一个功能，需要使用单片机进行实时的PWM转发，Debug的时候非常想要一个示波器。遂淘宝之。看价格，放弃。

300块难不倒英雄汉。既然买不起专业的东西，用现有的东西拼凑一下总是可以的。声卡就是一个非常好的选择。它和示波器可谓是一脉相承，很多地方都是相似的。

关于在PC上模拟示波器的软件，Google一下可以找到很多，简单的使用的话，免费的[Soundcard Oscilloscope](https://www.zeitnitz.eu/scope_en)可谓是很好的选择。

然而既然单独写一篇Blog，事情显然没有这么简单。

## 开始作大死
用声卡做示波器，首先想到的就是精度。44100Hz，采样周期为22us，加上16Bit深度，完全可以胜任常见的示波器需求。然而还有两个问题需要考虑：
1. 如果声卡太烂：
  - 很烂的声卡通常没有Line In，只有Mic接口，所以输入信号要通过：话放->前级放大->PC->后级放大->功放 这么多东西。可以想象一下，很烂的声卡，理所当然的配上4个很烂的放大器，信号失真会变成什么样子。
  - 耳朵的灵敏度远远超过眼睛，某些类型的信号（比如我想检测的PWM信号），用耳朵听，比用眼睛看，效率更高，效果更好。所以如果可以在输入的同时进行监听，对快速Debug有很大的帮助。这么一想，普通的示波器哪有这么高端的功能; ) 好开心。然而如果声卡太烂的话，在输入与监听输出之间会有0.5秒左右的延迟。
  - 如果是板载声卡，电磁干扰会相当严重。尤其是会受到GPU的干扰。当进行密集的图形操作时，可以在耳机中听到明显的干扰噪声。
2. 如果声卡太好：
  - 线接错了，声卡炸了
  - 信号路由可能是一个问题（下文详述）

3. 用声卡采样，由于放大电路的存在，以及硬件之间的差异，最后得到的音频信号，只能反应时序上的“相对深度”，不能直接获取绝对数值。因此这种示波器更适合查看数字电路的波形（只需要知道时序上的高低）。

手里刚好有一台UR44，真是天助我也。UR44可以拥有3.5mm 的两个 Line In接口，精度显然是没什么需要担心的了。接下来需要解决“声卡太好”的两个问题。

### 接线
说干就干。先把百宝箱翻个底朝天，找到可以用的东西：

- 一对万用表笔，剪开接头处的“包皮”
- 一根2.5mm 公对公音频线
- 一个2.5mm母／3.5mm公转接头
- 一根2.5mm母，转不知道什么东西的线，用在来给不知道什么牌子的遥控器接盗版模拟器用。剪开备用。
- 一堆电阻

![百宝箱里的东西](/images/articles/0.jpg)

按顺序连接起来就好了。照片右侧可以看到两个需要“剪开”的东西连接在一起的黑漆漆的一坨。

这样只需要破坏一根没什么卵用的线。别的都可以拆下来用在别的什么地方。表笔只是剪掉了“包皮”，并不影响使用。

接线的时候，使用的电阻是一个问题。这里详细说明一下。

- 首先，声卡的音频输入，并不是传统的“地对空”（GND-VCC)。声卡是“公平自在心中”，不需要额外的地线。两个输入段子，一个向0点以上走，一个向0点以下走。通常来说，如果两者的走势明显不对称，就是所谓的“直流偏移”（DC Offset），需要校正。在这里，因为我的输出端是“地对空”的形式，GND端断然无法继续向下，所以就人为地制造了一个”直流偏移”，监视到的波形应该在零点的一侧。
- 其次，声卡的Line In，用来接受未经过放大的信号，也就是说，输入电流很小。与普通的消费级声卡不同，UR44的Line In只会做Line In最本分的事情，而不是像一些消费级声卡一样，拥有“自动识别”功能——如果输入很大，就跳过前级放大。

因此，电阻连接如下：
![电阻连接](/images/articles/1.png)

- R0 与 R1 都必不可少！ 由于音频输入没有GND，向上和向下都是输入范围，所以两表笔必须都有保护电阻！
- R0 与 R1 最好使用可变电阻，可变范围应该至少大于20K
- 我没有那么大的可变电阻器，所以使用了R0=20K， R1=1M的定值电阻。
  - 由于我在Debug的时候，MCU通过USB接口供电，MCU与声卡共地。因此只需要使用红表笔。为了防止黑笔乱跑引起故障，采用了1M的超大电阻。
  - 经过测试， 当R0=20K的时候，输出最高电压约为3V的PWM，很合适。

### 信号路由
声卡太好也是罪！由于UR44的Line In在5、6通道，而系统默认输入只使用1、2通道。所以在“音频设置”中选择设备的方法，不能选到Line In通道。要使用别的通道，必须借助CoreAudio，ASIO之类的驱动。而前面所说的[Soundcard Oscilloscope](https://www.zeitnitz.eu/scope_en)并不支持这些额外的驱动。所以要么用耳朵听，要么直接看波形，数采样。

如果你有更好的办法，请告诉我。

> _如果用DAW内录一圈，强行把ch5的输出搞进ch1，由于软件“音染”的存在，信号会变得面目全非。别问我是怎么知道的……_

### 如果只能用笨办法的话……
由于我用习惯了Logic，所以下面就用Logic做个示范：

首先就是喜闻乐见的录音。打开录音，接好表笔，坐等。

![录音](/images/articles/5.png)

然后疯狂的放大，就可以看到波形。
![波形](/images/articles/6.png)

要测量一段时间的长度，可以将首尾位置如图所示的标尺的数值相减，就可以得到一段时间长度。标尺的数值可以在“Preferences->Display”中设定。这里是“时:分:秒.采样”。每个采样的时间是 1,000,000/采样率 us.

![标尺](/images/articles/7.png)

我这里两个标尺的数值相差211个采样，采样率为192kHz，持续时间即为1099us.

通常都是44.1kHz，如果想要高采样率，可以在项目设置中调整：

![采样率设置](/images/articles/2.png)
![采样率设置](/images/articles/3.png)

设置不同的采样率需要声卡的支持。

如果需要采集模拟信号，最好把位深度也设置高。常用的有16位整型，24位整型。有些软件还支持32位浮点，范围就更宽了。

![位深度设置](/images/articles/4.png)

### 最后
就Debug PWM输出而言，用耳机监听一下，比用眼睛看，效率高多了。

> _这个方波噪音真的有够恶心_

> _我还是去找找别的方法。找到了再更新_
